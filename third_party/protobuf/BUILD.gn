# Copyright 2014 The Chromium Authors
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.
if (is_android) {
  import("//build/config/android/rules.gni")
}

# Includes default args like 'enable_js_protobuf'.
import("proto_library.gni")
import("proto_sources.gni")
if (enable_js_protobuf) {
  import("//third_party/closure_compiler/compile_js.gni")
}

config("protobuf_config") {
  include_dirs = [
    "src",
    "src/src",
    "src/third_party/utf8_range/",
    "//",
  ]
  defines = [
    #"GOOGLE_PROTOBUF_NO_RTTI",
    #"PROTOBUF_INTERNAL_BOUNDS_CHECK_MODE_ABORT",
  ]
  if (!is_win) {
    defines += [ "HAVE_PTHREAD" ]
  }
}

config("protobuf_config_internal") {
  include_dirs = [ "./src/third_party/utf8_range" ]

  if (is_clang) {
    cflags = [
      # For src/google/protobuf/map.cc:
      "-Wno-deprecated-this-capture",
    ]
  }
}

proto_library("struct_proto") {
  sources = [ "src/google/protobuf/struct.proto" ]
}

if (is_component_build) {
  config("protobuf_use_dlls") {
    defines = [ "PROTOBUF_USE_DLLS" ]
  }
}

# This config should be applied to targets using generated code from the proto
# compiler. It sets up the include directories properly.
config("using_proto") {
  include_dirs = [ "src/src" ]
}

static_library("protobuf_lite") {
  sources = protobuf_lite_sources
  public = protobuf_headers

  configs += [ ":protobuf_config_internal" ]

  # Build protobuf_lite with full optimizations so Clang can optimize the
  # initializer out. See 0029-make-initializers-optimizable.patch.
  if (!is_debug && is_android) {
    configs -= [ "//build/config/compiler:default_optimization" ]
    configs += [ "//build/config/compiler:optimize_max" ]
  }

  if (is_win) {
    configs -= [ "//build/config/win:lean_and_mean" ]
  }

  public_configs = [ ":protobuf_config" ]

  deps = [ ":utf8_range" ]

  public_deps = [ "//third_party/abseil-cpp:absl" ]

  # Required for component builds. See http://crbug.com/172800.
  if (is_component_build) {
    public_configs += [ ":protobuf_use_dlls" ]
    defines = [ "LIBPROTOBUF_EXPORTS" ]
  }
}

# This is the full, heavy protobuf lib that's needed for c++ .protos that don't
# specify the LITE_RUNTIME option. The protocol compiler itself (protoc) falls
# into that category. Do not use in Chrome code.
static_library("protobuf_full") {
  deps = [ ":utf8_range" ]

  # In component build, protobuf_full can't depend on protobuf_lite because
  # it uses non-PROTOBUF_EXPORT symbols; in non-component build, protobuf_full
  # must have protobuf_lite as a dependency instead of building
  # protobuf_lite_sources to avoid ODR violations in targets that link both.
  # See crbug.com/1338164.
  if (is_component_build) {
    sources = protobuf_lite_sources + protobuf_sources
  } else {
    sources = protobuf_sources
    deps += [ ":protobuf_lite" ]
  }

  #include_dirs = [ "src/upb", "src/src" ]
  include_dirs = [ "src/upb/reflection/cmake/" ]

  #sources += protobuf_port_sources + protobuf_port_headers
  #sources += protobuf_upb_sources + protobuf_upb_headers
  #sources += protobuf_compiler_cpp_sources + protobuf_compiler_cpp_headers
  sources += protoc_upb_sources + protoc_upb_headers
  sources += protobuf_compiler_csharp_sources + protobuf_compiler_csharp_headers
  sources += protobuf_compiler_objectivec_sources +
             protobuf_compiler_objectivec_headers
  sources += protobuf_compiler_rust_sources + protobuf_compiler_rust_headers

  #sources +=
  #    protobuf_compiler_java_full_sources + protobuf_compiler_java_full_headers
  #sources += protobuf_compiler_java_sources + protobuf_compiler_java_headers
  sources += protobuf_compiler_kotlin_sources + protobuf_compiler_kotlin_headers

  #sources += protobuf_compiler_sources + protobuf_compiler_headers
  sources += protobuf_compiler_php_sources + protobuf_compiler_php_headers
  sources += protobuf_compiler_ruby_sources + protobuf_compiler_ruby_headers

  public = protobuf_headers

  public_deps = [ "//third_party/abseil-cpp:absl" ]

  configs += [ ":protobuf_config_internal" ]

  # Remove coverage and Sanitizers other than ASan for a performance boost when
  # fuzzing. ASan can't be removed here because of a bug preventing unsanitized
  # code from using libc++, which protobuf_full uses.

  if (is_win) {
    #configs -= [ "//build/config/win:lean_and_mean" ]
  }
  public_configs = [ ":protobuf_config" ]

  #cflags = protobuf_lite_cflags

  defines = [ "HAVE_ZLIB" ]
}

# Only compile the compiler for the host architecture.
if (current_toolchain == host_toolchain) {
  # Code for compiling bindings for individual languages are pulled into
  # separate build targets for two reasons:
  # 1. To avoid naming collisions between files in the same source set.
  # 2. Because Chromium doesn't need a lot of the languages.

  # Note we have to separate the 3 Java directories (java/, java/full/ and
  # java/lite/) into 3 different GN targets because they contain .cc files with
  # identical names (e.g. message.cc), and source_set() doesn't support multiple
  # .cc files with the same basename. We use a single target for the headers as
  # these directories tend to cross-#include each other which makes things
  # challenging for GN header dependency checks.
  source_set("protoc_java_all_headers") {
    sources = protoc_java_all_headers

    configs += [ ":protobuf_config_internal" ]

    public_deps = [ ":protobuf_full" ]
  }
  source_set("protoc_java") {
    sources = protoc_java_sources

    configs += [ ":protobuf_config_internal" ]

    public_deps = [
      ":protobuf_full",
      ":protoc_java_all_headers",
    ]
  }
  source_set("protoc_java_full") {
    sources = protoc_java_full_sources

    configs += [ ":protobuf_config_internal" ]

    public_deps = [
      ":protobuf_full",
      ":protoc_java_all_headers",
    ]
  }
  source_set("protoc_java_lite") {
    sources = protoc_java_lite_sources

    configs += [ ":protobuf_config_internal" ]

    public_deps = [
      ":protobuf_full",
      ":protoc_java_all_headers",
    ]
  }

  source_set("protoc_cpp") {
    sources = protoc_cpp_sources + protoc_cpp_headers

    configs += [ ":protobuf_config_internal" ]

    public_deps = [ ":protobuf_full" ]
  }

  source_set("protoc_python") {
    sources = protoc_python_sources + protoc_python_headers

    configs += [ ":protobuf_config_internal" ]

    public_deps = [ ":protobuf_full" ]
  }

  # protoc generates language-specific bindings from protos.
  static_library("protoc_lib") {
    sources = protoc_sources + protoc_headers

    configs += [ ":protobuf_config_internal" ]

    public_configs = [ ":protobuf_config" ]

    public_deps = [ ":protobuf_full" ]
    deps = [
      ":protoc_cpp",
      ":protoc_java",
      ":protoc_java_all_headers",
      ":protoc_java_full",
      ":protoc_java_lite",
      ":protoc_python",
    ]
    allow_circular_includes_from = [
      ":protoc_java",
      ":protoc_java_all_headers",
      ":protoc_java_full",
      ":protoc_java_lite",
      ":protoc_cpp",
      ":protoc_python",
    ]
  }

  executable("protoc") {
    sources = [ "src/src/google/protobuf/compiler/main.cc" ]

    configs += [ ":protobuf_config_internal" ]

    deps = [
      ":protoc_cpp",
      ":protoc_java",
      ":protoc_java_full",
      ":protoc_java_lite",
      ":protoc_lib",
      ":protoc_python",
      "//third_party/abseil-cpp:absl",
      "//third_party/abseil-cpp:base_config",
    ]
    if (enable_js_protobuf) {
      deps += [ "//third_party/protobuf-javascript:protoc-gen-js" ]
    }
  }
}

source_set("utf8_range") {
  sources = [
    "src/third_party/utf8_range/utf8_range.c",
    "src/third_party/utf8_range/utf8_range.h",
    "src/third_party/utf8_range/utf8_validity.h",
  ]

  configs += [ ":protobuf_config_internal" ]

  deps = [ "//third_party/abseil-cpp:absl" ]
}

copy("copy_google_protobuf") {
  # See README.chromium for how this file is generated.
  sources = pyproto_sources + [ "python/google/protobuf/descriptor_pb2.py" ]
  outputs = [ "$proto_python_root/google/protobuf/{{source_file_part}}" ]
}

copy("copy_google_protobuf_internal") {
  # See README.chromium for how this file is generated.
  sources = pyproto_internal_sources +
            [ "python/google/protobuf/internal/python_edition_defaults.py" ]
  outputs =
      [ "$proto_python_root/google/protobuf/internal/{{source_file_part}}" ]
}

# Build time dependency for action rules.
group("py_proto") {
  public_deps = [
    ":copy_google_protobuf",
    ":copy_google_protobuf_internal",
  ]
}

# Note: This exists for Cronet in AOSP where we can't import prebuilts. We import
# the raw sources and compile them using a specialized pipeline. See crbug.com/419480317.
if (is_android && is_cronet_for_aosp_build) {
  android_library("proto_runtime_lite_java") {
    sources = javaproto_sources
  }
}

# Runtime dependency if the target needs the python scripts.
group("py_proto_runtime") {
  deps = [ ":py_proto" ]

  # Targets that depend on this should depend on the copied data files.
  data = get_target_outputs(":copy_google_protobuf")
  data += get_target_outputs(":copy_google_protobuf_internal")
}
